<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SmartForecast ‚Äî Trading Simulator</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <style>
    /* Set relative positioning for body to layer particles correctly */
    body {
        background-color: #121212;
        color: #EEE;
        font-family: Arial, sans-serif;
        padding: 20px;
        position: relative;
        min-height: 100vh;
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Marquee ‡∏ó‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
        padding-bottom: 60px;
    }

    /* Particle background container styling */
    #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Places it behind all other content */
        background-color: #121212;
    }

    h2 { text-align: center; margin: 0; }

    /* === Glow gradient ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Index === */
    @keyframes animateGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .glow-gradient {
      font-size: 2em;
      font-weight: bold;
      background: linear-gradient(90deg, #00e676, #00bfa5, #40c4ff, #00e676);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 1px;
      background-size: 200% auto;
      animation: animateGradient 5s ease-in-out infinite;
    }

    p.subtitle { text-align:center; color:#bbb; margin-top:6px; }

    .stock-menu { text-align:center; margin: 16px 0 10px; }
    .stock-menu a { margin-right: 12px; font-size: 1.05em; text-decoration: none; color: #00c853; padding: 5px 10px; border-radius: 6px; transition: background .3s ease; }
    .stock-menu a:hover { background:#2c2c2c; }
    .stock-menu a.active { background:#00c853; color:#111; }

    .panel { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; padding: 14px; background:#1b1b1b; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,.35); margin: 10px 0 18px; }
    .panel .item { display:flex; flex-direction:column; gap:6px; }
    .panel label { color:#bbb; font-size:.92em; }
    .panel input, .panel select { background:#101010; border:1px solid #2b2b2b; color:#eee; border-radius:8px; padding:8px 10px; outline:none; }
    .panel .row { grid-column: 1 / -1; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    /* === Modern dropdowns (‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÉ‡∏´‡∏°‡πà) === */
    select {
      background:#101010;
      border:1px solid #2b2b2b;
      color:#eee;
      border-radius:10px;
      padding:10px 36px 10px 12px;
      outline:none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23ccc' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
      transition: transform .2s ease, filter .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    select:hover {
      transform: translateY(-2px);
      filter: brightness(1.08);
      box-shadow: 0 8px 20px rgba(0,0,0,.45);
      border-color: #00c853;
    }
    select:focus {
      border-color: #00c853;
      box-shadow: 0 0 0 3px rgba(0,200,83,.2);
    }

    /* Buttons */
    .btn { background:#00c853; color:#111; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; box-shadow: 0 0 0 rgba(0,0,0,0); transition: transform .2s ease, filter .2s ease, box-shadow .2s ease; }
    .btn:hover { transform: scale(1.1); filter: brightness(1.2); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
    .btn:active { transform: scale(.98); }

    #latest-date-info { text-align:center; font-size:.95em; color:#bbb; margin: 4px 0 14px; min-height: 22px; display:flex; align-items:center; justify-content:center; }

    .cards { display:grid; grid-template-columns: 1fr; gap:14px; }
    .card { background:#1a1a1a; border-radius:12px; padding:12px; box-shadow: 0 0 10px rgba(255,255,255,.04); }

    /* === ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î === */
    .card h3 { margin: 6px 0 10px; font-size:1.3em; color:#fff; letter-spacing: .3px; }

    #equity-graph, #price-graph { width:100%; height:420px; }

    .metrics { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    .metric { background:#141414; border:1px solid #2a2a2a; border-radius:10px; padding:10px; }
    .metric .k { color:#bbb; font-size:.9em; }
    .metric .v { font-weight:700; font-size:1.1em; }

    #calcResult { display: none; }

    .table-wrap { overflow:auto; border-radius: 10px; border: 1px solid #2a2a2a; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px; border-bottom:1px solid #262626; font-size:.95em; }
    th { text-align:left; color:#bbb; background:#161616; position: sticky; top: 0; }
    tr:hover { background:#181818; }

    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; font-size:.85em; }
    .pill.buy { background:#264d2a; color:#65ff84; }
    .pill.sell { background:#4d2626; color:#ff7b7b; }
    .pill.open { background:#2b3642; color:#74c0ff; }
    .pill.closed { background:#2b4230; color:#78e08f; }

    .muted { color:#ffffff ; }
    .pos { color:#65ff84; font-weight:700; }
    .neg { color:#ff7b7b; font-weight:700; }

    .toolbar { display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:8px; }
    .link { color:#00c853; text-decoration:none; }

    .page-switch { position: fixed; top: 16px; right: 16px; z-index: 9999; background: #00c853; color: #111; text-decoration: none; padding: 10px 14px; border-radius: 10px; font-weight: 700; box-shadow: 0 6px 16px rgba(0,0,0,.35); transition: transform .2s ease, filter .2s ease, box-shadow .2s ease; }
    .page-switch:hover { filter: brightness(1.2); box-shadow: 0 8px 20px rgba(0,0,0,.45); transform: scale(1.1); }
    .page-switch:active { transform: scale(.98); }

    .history-controls { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:8px; flex-wrap:wrap; }
    .history-sum { display:flex; gap:10px; flex-wrap:wrap; }
    .chip { background:#101010; border:1px solid #2b2b2b; padding:6px 10px; border-radius:999px; }

    /* === Calculator input (ADD) === */
    .calc .input-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .calc .input-wrap .prefix {
      position: absolute;
      left: 12px;
      color: #00c853 ;
      pointer-events: none;
      font-weight: 600;
    }
    .calc input#calcAmount {
      background: #101010;
      border: 1px solid #2b2b2b;
      color: #eee;
      border-radius: 10px;
      padding: 10px 14px 10px 28px; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ $ */
      outline: none;
      width: 180px;
      transition: transform .2s ease, filter .2s ease, box-shadow .2s ease, border-color .2s ease;
    }

    .calc input#calcAmount:focus {
      border-color: #00c853;
      box-shadow: 0 0 0 3px rgba(0,200,83,.2);
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏≠‡∏á number input */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }


    /* === Footer Marquee (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Index) === */
    @keyframes marquee-scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    .footer-marquee {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #1a1a1a;
      border-top: 1px solid #333;
      z-index: 999;
      overflow: hidden;
    }
    .marquee-content {
      display: flex;
      width: 200%;
      margin: 0;
      animation: marquee-scroll 50s linear infinite;
    }
    .marquee-content span {
      width: 50%;
      padding: 10px 0;
      color: #ccc;
      font-size: 0.9em;
      white-space: nowrap;
    }

    /* === Loading Overlay (ADD) === */
    #loading-overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center; gap: 14px;
      z-index: 10001;
    }
    #loading-overlay.show{ display: flex; }
    .spinner{
      width: 42px; height: 42px;
      border: 3px solid #2b2b2b; border-top-color: #00c853;
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    .loading-text{ color:#00c853; font-weight:700; letter-spacing:.3px; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* === Tutorial / Words Buttons (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô index) === */
    .tutorial-button {
      position: fixed; top : 16px; left: 16px; z-index: 9999;
      background: #40c4ff; color: #111; text-decoration: none; padding: 10px 14px; border-radius: 10px; font-weight: 700;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      transition: transform .2s ease, filter .2s ease, box-shadow .2s ease;
      cursor: pointer;
    }
    .tutorial-button:hover {
      filter: brightness(1.2);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      transform: scale(1.1);
    }
    .tutorial-button:active { transform: scale(.98); }

    .glossary-button {
      position: fixed; top: 16px; left: 140px; z-index: 9999;
      background: #ffd740; color: #111; text-decoration: none; padding: 10px 14px; border-radius: 10px; font-weight: 700;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      transition: transform .2s ease, filter .2s ease, box-shadow .2s ease;
      cursor: pointer;
    }
    .glossary-button:hover {
      filter: brightness(1.06);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      transform: scale(1.1);
    }
    .glossary-button:active { transform: scale(.98); }

    /* === Modal (popup) === */
    .modal {
      display: none; position: fixed; z-index: 10000;
      left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto; background-color: rgba(0, 0, 0, 0.7);
      align-items: center; justify-content: center;
    }
    @keyframes animatePopup {
      from { opacity: 0; transform: scale(0.9) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal-content {
      background-color: #2c2c2c; color: white; margin: auto;
      padding: 20px; border: 1px solid #555; border-radius: 10px;
      width: 80%; max-width: 900px; position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,.5);
      animation: animatePopup 0.3s ease-out;
    }
    .close-btn {
      color: #aaa; position: absolute; top: 10px; right: 20px;
      font-size: 28px; font-weight: bold; cursor: pointer;
    }
    .close-btn:hover, .close-btn:focus { color: #fff; text-decoration: none; }

    /* === Glossary list === */
    .glossary-list dl { padding: 0 15px; }
    .glossary-list dt {
      font-size: 1.1em; font-weight: bold; color: #ffd740;
      margin-top: 15px; margin-bottom: 5px;
    }
    .glossary-list dd {
      margin-left: 0; color: #ddd; line-height: 1.6;
      padding-bottom: 10px; border-bottom: 1px solid #333;
    }
    .glossary-list dd:last-child { border-bottom: none; }
    body.modal-open {
      overflow: hidden;     /* ‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ‡∏û‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ position:fixed ‡πÉ‡∏ô JS */
    }

    /* ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÑ‡∏î‡πâ */
    .modal-content {
      max-height: 80vh;
      overflow: auto;
    }

    /* ‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏™‡∏Å‡∏£‡∏≠‡∏•‡∏´‡∏•‡∏∏‡∏î‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ô‡∏≠‡∏Å‡πÇ‡∏°‡∏î‡∏±‡∏• (Chrome/Android) */
    .modal {
      overscroll-behavior: contain;
    }
    .page-container {
        max-width: 1500px;
        margin: 0 auto;
    }
  </style>
</head>
<body>
  <div id="particles-js"></div>

  <!-- Loading overlay (ADD) -->
  <div id="loading-overlay" aria-live="polite">
    <div class="spinner" role="progressbar" aria-label="Loading"></div>
    <div class="loading-text">Loading‚Ä¶</div>
  </div>

  <!-- Tutorial & Words buttons (ADD) -->
  <a id="tutorial-btn" class="tutorial-button" title="Show Tutorial">? Tutorial</a>
  <a id="glossary-btn" class="glossary-button" title="Show Terms">? Words</a>

  <a class="page-switch" href="/" title="Back to Multi Stock Forecast" aria-label="Back to Multi Stock Forecast">
    ‚Üê Forecast
  </a>
<div class="page-container">
  <h2><span class="glow-gradient">SmartForecast</span></h2>
  <p class="subtitle">Trading Simulator ‚Äî Powered by AI Forecasts</p>

  <div id="latest-date-info"></div>

  <div class="cards">
    <div class="card">
      <h3>Portfolio Growth</h3>
      <div style="margin-bottom:8px;">
        <label class="muted">Model:</label>
        <select id="equityModel">
          <option value="all">All models</option>
          <option value="lstm">LSTM</option>
          <option value="trans">Transformer</option>
          <option value="tcn">TCN+GRU</option>
        </select>
      </div>
      <div id="equity-graph"></div>
    </div>

    <div class="card">
      <h3>Summary</h3>
      <div class="calc" style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label class="muted">Calculator ‚Äî Invest:</label>
        <span class="input-wrap">
          <span class="prefix">$</span>
          <input id="calcAmount" type="number" value="10000" min="0" step="100" inputmode="decimal" aria-label="Investment amount" />
        </span>
        <button class="btn" id="calcBtn">Compute</button>
        <span id="calcResult" class="chip"></span>
      </div>
      <div class="metrics" id="metrics"></div>
    </div>

    <div class="card">
      <h3>Trade Signals</h3>
        <div class="stock-menu" id="stock-menu">
          {% for ticker in tickers %}
            <a href="#" class="stock-link" data-ticker="{{ ticker }}">{{ ticker }}</a>
          {% endfor %}
        </div>
      <div id="price-graph"></div>
    </div>

    <div class="card">
      <h3>Trading History</h3>
        <div>
          <label class="muted">Filter table:</label>
          <select id="histModel">
            <option value="all">All models</option>
            <option value="lstm">LSTM</option>
            <option value="trans">Transformer</option>
            <option value="tcn">TCN+GRU</option>
          </select>

          <select id="histStatus">
            <option value="all">All status</option>
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>

          <select id="histTicker">
            <option value="all">All tickers</option>
            {% for ticker in tickers %}
              <option value="{{ ticker }}">{{ ticker }}</option>
            {% endfor %}
          </select>

          <button class="btn" id="resetHistory">Reset</button>
        </div>
      </div>
      <div class="history-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom:6px;">
        <div class="history-sum" id="historySums"></div>
        <label style="font-size:.9em; color:#bbb; white-space:nowrap;">
          <input type="checkbox" id="toggleErrorCol" /> Show Prediction Error %
        </label>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Ticker</th>
              <th>Model</th>
              <th>Shares</th>
              <th>Invested</th>
              <th>Entry (DD-MM-YY)</th>
              <th>Entry Px</th>
              <th>Expected (DD-MM-YY)</th>
              <th>Expected Px</th>
              <th>Current (DD-MM-YY)</th>
              <th>Current Px</th>
              <th>Exit (DD-MM-YY)</th>
              <th>Exit Px</th>
              <th>Net P&L</th>
              <th>Return %</th>
              <th class="col-error" style="display:none;">Pred. Error %</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>
    <div id="pagination" style="margin-top:8px; text-align:center;"></div>
    </div>


  <!-- Tutorial Modal (ADD) -->
  <div id="tutorial-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3 style="text-align:center; color:#40c4ff;">Trading Simulator ‚Äî Tutorial</h3>
      <p style="color:#ccc; margin-top:8px;">
        ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏∏‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î <b>Trade Signals</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ã‡∏∑‡πâ‡∏≠/‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ)<br>
        ‚Ä¢ ‡∏Å‡∏£‡∏≤‡∏ü <b>Portfolio Growth</b> ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>Model</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô Equity ‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏£‡∏ß‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡πÇ‡∏°‡πÄ‡∏î‡∏• (LSTM/Transformer/TCN+GRU)<br>
        ‚Ä¢ ‡∏Å‡∏•‡πà‡∏≠‡∏á <b>Summary</b> ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Final Equity, Total Return, Max Drawdown, Win Rate) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ <b>Calculator ‚Äî Invest</b> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏∏‡∏ô√ó‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏£‡∏ß‡∏°<br>
        ‚Ä¢ <b>Trading History</b> ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á Model/Status/Ticker ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <i>Pred. Error %</i> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå<br>
        ‚Ä¢ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &larr; <b>Forecast</b> ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
      </p>
    </div>
  </div>

  <!-- Words / Glossary Modal (ADD) -->
  <div id="glossary-modal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h3 style="text-align:center; color:#ffd740;">Words (‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏π‡πâ) ‚Äî Trading Simulator</h3>
      <div class="glossary-list">
        <dl>
          <dt>Portfolio Growth (Equity Curve)</dt>
          <dd>‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏∞‡∏™‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ó‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (All/LSTM/Transformer/TCN+GRU)</dd>

          <dt>Final Equity</dt>
          <dd>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (USD)</dd>

          <dt>Total Return (%)</dt>
          <dd>‡∏ú‡∏•‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏£‡∏ß‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏≠‡∏£‡πå‡∏ï (All = ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•, ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏• = ‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏±‡πâ‡∏ô)</dd>

          <dt>Max Drawdown (%)</dt>
          <dd>‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏•‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏û‡∏µ‡∏Å‡∏Ç‡∏≠‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡∏°‡∏≤ ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏û‡∏≠‡∏£‡πå‡∏ï</dd>

          <dt>Win Rate (%)</dt>
          <dd>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</dd>

          <dt>Calculator ‚Äî Invest</dt>
          <dd>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏π‡∏ì‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏±‡∏ö <b>Total Return (%)</b> ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å Summary ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‚âà)</dd>

          <dt>Trade Signals (Markers)</dt>
          <dd>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå BUY/EXIT ‡∏ö‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á (‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡πÇ‡∏°‡πÄ‡∏î‡∏•: LSTM ‡πÅ‡∏î‡∏á, Transformer ‡∏ü‡πâ‡∏≤, TCN+GRU ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á) ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏à‡∏∏‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏≠‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•</dd>

          <dt>Open / Closed</dt>
          <dd>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: <b>Open</b> = ‡∏¢‡∏±‡∏á‡∏ñ‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà, <b>Closed</b> = ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß</dd>

          <dt>Invested</dt>
          <dd>‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (USD)</dd>

          <dt>Net P&L</dt>
          <dd>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡∏ô/‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏ß‡πâ)</dd>

          <dt>Return %</dt>
          <dd>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏±‡πâ‡∏ô</dd>

          <dt>Expected Date / Expected Px</dt>
          <dd>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà <i>‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á</i> ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≠‡∏ô‡∏õ‡∏¥‡∏î)</dd>

          <dt>Pred. Error %</dt>
          <dd>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ä‡πá‡∏Å‡∏ö‡πá‡∏≠‡∏Å‡∏ã‡πå ‚ÄúShow Prediction Error %‚Äù)</dd>

          <dt>Models</dt>
          <dd><b>LSTM</b> (‡∏à‡∏≥‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏î‡∏µ), <b>Transformer</b> (‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏Å‡∏•), <b>TCN+GRU</b> (‡∏•‡∏π‡∏Å‡∏ú‡∏™‡∏°‡∏°‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°+‡∏•‡∏≥‡∏î‡∏±‡∏ö)</dd>
        </dl>
      </div>
    </div>
  </div>
</div>
  <!-- Footer Marquee -->
  <div class="footer-marquee">
    <div class="marquee-content">
      <span>
        ‚ö†Ô∏è <strong>Disclaimer:</strong> This platform is for educational and informational purposes only. It does not constitute financial or investment advice. Trading and investing involve risks, and you should conduct your own research or consult a licensed financial advisor before making investment decisions.
      </span>
      <span>
        ‚ö†Ô∏è <strong>Disclaimer:</strong> This platform is for educational and informational purposes only. It does not constitute financial or investment advice. Trading and investing involve risks, and you should conduct your own research or consult a licensed financial advisor before making investment decisions.
      </span>
    </div>
  </div>

  <script>
    let currentTicker = null;
    let lastSim = null;

    /* === Loading helpers (ADD) === */
    function showLoading(msg){
      $('#loading-overlay .loading-text').text(msg || 'Loading‚Ä¶');
      $('#loading-overlay').addClass('show');
    }
    function hideLoading(){
      $('#loading-overlay').removeClass('show');
    }

    // ---------- Format helpers ----------
    function fmt(n, d = 2) {
      if (n === null || n === undefined || n === '') return "-";
      let v = Number(n);
      if (!Number.isFinite(v)) return "-";
      if (Math.abs(v) < 1e-8) return "0";
      return v.toLocaleString(undefined, { maximumFractionDigits: d, minimumFractionDigits: d });
    }
    function fmtPnL(value, prefix = "$") {
      if (value === null || value === undefined || value === '') return "-";
      let v = Number(value);
      if (!Number.isFinite(v)) return "-";
      if (Math.abs(v) < 1e-8) return prefix + "0.00";
      return prefix + fmt(v);
    }

    function fmtPct(value) {
      if (value === null || value === undefined || value === '') return "-";
      let v = Number(value);
      if (!Number.isFinite(v)) return "-";
      if (Math.abs(v) < 1e-8) return "0%";
      return fmt(v) + "%";
    }

    function fmtPnLWithSign(value, prefix = "$") {
      if (value === null || value === undefined || value === '') return "-";
      let v = Number(value);
      if (!Number.isFinite(v)) return "-";
      if (Math.abs(v) < 1e-8) return prefix + "0.00";
      return (v > 0 ? "+" : "") + prefix + fmt(v);
    }

    function fmtPctWithSign(value) {
      if (value === null || value === undefined || value === '') return "-";
      let v = Number(value);
      if (!Number.isFinite(v)) return "-";
      if (Math.abs(v) < 1e-8) return "0%";
      return (v > 0 ? "+" : "") + fmt(v) + "%";
    }

    function pnlClass(value) {
      if (value === null || value === undefined || value === '') return "muted";
      let v = Number(value);
      if (!Number.isFinite(v) || Math.abs(v) < 1e-8) return "muted";
      return v > 0 ? "pos" : "neg";
    }
    function fmtDate(dateStr) {
      if (!dateStr || dateStr === '-') return '-';
      let d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      let dd = String(d.getDate()).padStart(2, '0');
      let mm = String(d.getMonth() + 1).padStart(2, '0');
      let yy = String(d.getFullYear()).slice(-2);
      return `${dd}-${mm}-${yy}`;
    }
    function calcErrorPct(r) {
      if (String(r.status).toLowerCase() !== 'closed') return "-";
      let expected = Number(r.expected_price);
      let exit = Number(r.exit_price);
      if (!Number.isFinite(expected) || expected === 0 || !Number.isFinite(exit)) return "-";
      let err = ((exit - expected) / expected) * 100.0;
      return (err > 0 ? "+" : "") + fmt(err) + "%";
    }


    // ---------- UI painters ----------
    function setActive(ticker) {
      $(".stock-link").removeClass("active");
      $(`.stock-link[data-ticker="${ticker}"]`).addClass("active");
    }
    let lastReturnPct = 0;
    function loadPerformance(model='all') {
      $.getJSON(`/performance?model=${model}`, function(res){
        lastReturnPct = res.total_return_pct;
        $("#metrics").html(`
          <div class="metric"><div class="k">Final Equity</div><div class="v">${fmtPnL(res.final_equity)}</div></div>
          <div class="metric"><div class="k">Total Return</div><div class="v ${pnlClass(res.total_return_pct)}">${fmtPct(res.total_return_pct)}</div></div>
          <div class="metric"><div class="k">Max Drawdown</div><div class="v ${pnlClass(-Math.abs(res.max_drawdown_pct))}">${fmtPct(res.max_drawdown_pct)}</div></div>
          <div class="metric"><div class="k"># Trades</div><div class="v">${res.num_trades}</div></div>
          <div class="metric"><div class="k">Win Rate</div><div class="v">${fmtPct(res.win_rate_pct)}</div></div>
        `);
      });
    }

    function plotEquity(model="all") {
      $.getJSON(`/equity_curve?model=${model}`, function(res){
        if (!res.dates || !res.equity || res.dates.length === 0) {
          $("#equity-graph").html("<div class='muted'>No equity curve data</div>");
          return;
        }

        let baseline = (model === "all") ? 30000 : 10000;
        let startDate = new Date("2025-08-01");

        let raw = res.dates.map((d,i)=>({
          date: new Date(d),
          equity: Number(res.equity[i])
        }));

        if (raw.length === 0) return;

        let latestPerDay = {};
        raw.forEach(r => {
          let key = r.date.toISOString().split("T")[0];
          latestPerDay[key] = r.equity;
        });

        let endDate = new Date(raw[raw.length-1].date);
        endDate.setDate(endDate.getDate());
        if (endDate < startDate) endDate = startDate;

        let allDays = [];
        let cur = new Date(startDate);
        while(cur <= endDate) {
          allDays.push(cur.toISOString().split("T")[0]);
          cur.setDate(cur.getDate()+1);
        }

        let dates = [], equity = [];
        let lastEquity = baseline;
        allDays.forEach(day => {
          if (latestPerDay[day] !== undefined) {
            lastEquity = latestPerDay[day];
          }
          dates.push(day);
          equity.push(lastEquity);
        });

        const trace = {
          x: dates,
          y: equity,
          mode:'lines+markers',
          name: (model === "all") ? "Equity (All)" : `Equity (${model.toUpperCase()})`,
          line:{ width:2, color:(model==="lstm"?"#ff5252":model==="trans"?"#29b6f6":model==="tcn"?"#ffeb3b":"#00e676") },
          marker:{ size:6 },
          hovertemplate:'Date: %{x}<br>Equity: %{y:.2f}<extra></extra>'
        };

        const layout = {
          title:'',
          xaxis:{ title:'Date', type:'date' },
          yaxis:{ title:'Equity (USD)', tickprefix:'$', tickformat:',.0f' },
          plot_bgcolor:'#1a1a1a',
          paper_bgcolor:'#1a1a1a',
          font:{color:'#fff'},
          showlegend:false
        };

        Plotly.newPlot('equity-graph', [trace], layout, {responsive:true});
      }).fail(function(){
        $("#equity-graph").html("<div class='muted'>Error loading equity curve</div>");
      });
    }

    function plotPriceWithMarkers(actualDates, actualPrices, ticker) {
      const maxPoints = 60;
      let dates = actualDates;
      let prices = actualPrices;

      if (dates.length > maxPoints) {
        dates = dates.slice(-maxPoints);
        prices = prices.slice(-maxPoints);
      }

      const priceTrace = {
        x: dates,
        y: prices,
        mode: 'lines',
        name: 'Actual Price',
        line: { color: '#00e676', width: 2 }
      };

      $.getJSON(`/markers/${ticker}`, function(res) {
        const markers = [];
        const modelStyles = {
          lstm:  { colorBuy:'#ff5252', colorExit:'#ff5252', symbolBuy:'triangle-up', symbolExit:'triangle-down', offset:0 },
          trans: { colorBuy:'#29b6f6', colorExit:'#29b6f6', symbolBuy:'triangle-up', symbolExit:'triangle-down', offset:-5 },
          tcn:   { colorBuy:'#ffeb3b', colorExit:'#ffeb3b', symbolBuy:'triangle-up', symbolExit:'triangle-down', offset:-10 }
        };

        for (const [model, style] of Object.entries(modelStyles)) {
          if (res[model]) {
            if (res[model].buy && res[model].buy.length) {
              markers.push({
                x: res[model].buy.map(b => b.date),
                y: res[model].buy.map(b => b.price + style.offset),
                mode: 'markers+text',
                text: `${model.toUpperCase()} BUY`,
                textposition: 'bottom center',
                name: `${model.toUpperCase()} BUY`,
                marker: { size: 12, symbol: style.symbolBuy, color: style.colorBuy },
                hovertemplate: res[model].buy.map(b => {
                  let idx = actualDates.indexOf(b.date);
                  let actual = (idx !== -1) ? actualPrices[idx] : b.price;
                  return `${actual.toFixed(2)}<br>${model.toUpperCase()} BUY<extra></extra>`;
                })
              });
            }

            if (res[model].exit && res[model].exit.length) {
              markers.push({
                x: res[model].exit.map(e => e.date),
                y: res[model].exit.map(e => e.price),
                mode: 'markers+text',
                text: `${model.toUpperCase()} EXIT`,
                textposition: 'top center',
                name: `${model.toUpperCase()} EXIT`,
                marker: { size: 12, symbol: style.symbolExit, color: style.colorExit },
                hovertemplate: res[model].exit.map(e => {
                  return `${model.toUpperCase()}: ${e.price.toFixed(2)}<extra></extra>`;
                })
              });
            }
          }
        }

        const layout = {
          title: '',
          paper_bgcolor: '#1a1a1a',
          plot_bgcolor: '#1a1a1a',
          font: {color: '#EEE'},
          margin: {t:30, l:40, r:20, b:40}
        };

        Plotly.newPlot('price-graph', [priceTrace, ...markers], layout, {responsive:true});
      });
    }

    function runSim(ticker) {
      // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå loading ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô"
      const params = new URLSearchParams({ model: 'lstm' });
      return $.getJSON(`/simulate/${ticker}?${params.toString()}`, function(sim){
        lastSim = sim;
        $('#latest-date-info').text(`üìÖ Latest update ${sim.future_dates[0]}`);
        const model = $('#equityModel').val() || "all";
        plotEquity(model);
        $.getJSON(`/data/${ticker}`, function(data){
          plotPriceWithMarkers(data.actual_dates, data.actual_prices, ticker);
        });
        loadHistory($('#histModel').val());
        loadPerformance('all');
      }).fail(function(xhr){
        alert(xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Simulation error');
      });
    }

    function paintHistorySums(res) {
      const t = res.totals || {overall_pnl:0, realized_pnl:0, open_pnl:0, invested_usd:0};
      let extra = '';
      if (res.model === 'all' && res.totals_by_model) {
        const m = res.totals_by_model;
        extra = `
          <span class="chip">LSTM: <b class="${pnlClass(m.lstm)}">${fmtPnL(m.lstm)}</b></span>
          <span class="chip">Transformer: <b class="${pnlClass(m.trans)}">${fmtPnL(m.trans)}</b></span>
          <span class="chip">TCN+GRU: <b class="${pnlClass(m.tcn)}">${fmtPnL(m.tcn)}</b></span>
        `;
      }
      $('#historySums').html(`
        <span class="chip">Total P&L: <b class="${pnlClass(t.overall_pnl)}">${fmtPnL(t.overall_pnl)}</b></span>
        <span class="chip">Realized: <b class="${pnlClass(t.realized_pnl)}">${fmtPnL(t.realized_pnl)}</b></span>
        <span class="chip">Open (Unrealized): <b class="${pnlClass(t.open_pnl)}">${fmtPnL(t.open_pnl)}</b></span>
        <span class="chip">Invested: <b>${fmtPnL(t.invested_usd)}</b></span>
        ${extra}
      `);
    }
    let historyData = [];
    let currentPage = 1;
    const pageSize = 10;

    function paintHistoryTable(items) {
      historyData = items || [];
      renderPage(currentPage);
    }

    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const pageItems = historyData.slice(start, end);

      const body = pageItems.map(r => {
        return `<tr>
          <td><span class="pill ${String(r.status).toLowerCase()}">${r.status}</span></td>
          <td>${r.ticker}</td>
          <td>${(r.model||'').toUpperCase()}</td>
          <td>${fmt(r.shares)}</td>
          <td>${fmtPnL(r.invested_usd)}</td>
          <td>${fmtDate(r.entry_date)}</td>
          <td>${fmtPnL(r.entry_price)}</td>
          <td>${fmtDate(r.expected_date)}</td>
          <td>${fmtPnL(r.expected_price)}</td>
          <td>${String(r.status).toLowerCase() === 'closed' ? '-' : fmtDate(r.current_date)}</td>
          <td>${String(r.status).toLowerCase() === 'closed' ? '-' : fmtPnL(r.current_price)}</td>
          <td>${r.exit_date ? fmtDate(r.exit_date) : '-'}</td>
          <td>${r.exit_price ? fmtPnL(r.exit_price) : '-'}</td>
          <td class="${pnlClass(r.net_pnl_usd)}">${fmtPnLWithSign(r.net_pnl_usd)}</td>
          <td class="${pnlClass(r.return_pct)}">${fmtPctWithSign(r.return_pct)}</td>
          <td class="col-error" style="display:none;">
            ${String(r.status).toLowerCase() === 'closed' && r.exit_price && r.expected_price
              ? fmtPctWithSign(((r.exit_price - r.expected_price) / r.expected_price) * 100.0)
              : "-"}
          </td>
        </tr>`;
      }).join('');

      $("#history-body").html(body || `<tr><td colspan="15" class="muted">No logs yet</td></tr>`);

      const totalPages = Math.ceil(historyData.length / pageSize);
      let html = "";
      if (totalPages > 1) {
        html += `<button class="btn" onclick="renderPage(${Math.max(1, page-1)})" ${page===1?'disabled':''}>Prev</button>`;
        html += ` <span class="chip">Page ${page} / ${totalPages}</span> `;
        html += `<button class="btn" onclick="renderPage(${Math.min(totalPages, page+1)})" ${page===totalPages?'disabled':''}>Next</button>`;
      }
      $("#pagination").html(html);
    }

    function loadHistory() {
        const model = $('#histModel').val() || "all";
        const status = $('#histStatus').val() || "all";
        const ticker = $('#histTicker').val() || "all";

      $.getJSON(`/logs?model=${model}&status=${status}&ticker=${ticker}`, function(res){
        paintHistorySums(res);
        paintHistoryTable(res.items);
      }).fail(function(){
        $("#history-body").html(`<tr><td colspan="17" class="muted">Failed to load logs</td></tr>`);
      });
    }

    // ---------- Init ----------
    $(document).ready(function(){
      const firstTicker = $(".stock-link").first().data("ticker");
      currentTicker = firstTicker; setActive(firstTicker); runSim(firstTicker);  // ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå overlay ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

      loadPerformance('all');

      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏∏‡πâ‡∏ô"
      $(".stock-link").click(function(e){
        e.preventDefault();
        const t = $(this).data('ticker');
        currentTicker = t;
        setActive(t);
        showLoading('Switching to ' + t + ' ‚Ä¶');
        runSim(t).always(function(){
          hideLoading();
        });
      });

      // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≠‡∏ô "‡∏Å‡∏î‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤"
      $('.page-switch').on('click', function(){
        showLoading('Opening page ‚Ä¶');
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á hide; ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
      });

      // Modal handlers (ADD)
      $('#tutorial-btn').click(function(){ $('#tutorial-modal').css('display','flex'); });
      $('#glossary-btn').click(function(){ $('#glossary-modal').css('display','flex'); });
      $('.close-btn').click(function(){ $(this).closest('.modal').css('display','none'); });
      $('.modal').click(function(e){ if(e.target === this){ $(this).css('display','none'); } });

      $('#resetHistory').click(function(){
        $('#histModel').val('all');
        $('#histStatus').val('all');
        $('#histTicker').val('all');
        loadHistory();
      });
      $('#equityModel').change(function(){
        const model = $(this).val();
        plotEquity(model);
        loadPerformance(model);
      });
      $('#histModel').change(function(){ loadHistory(); });
      $('#histStatus').change(function(){ loadHistory(); });
      $('#histTicker').change(function(){ loadHistory(); });
      $('#calcBtn').click(function(){
        let amt = Number($('#calcAmount').val());
        if (!Number.isFinite(amt) || amt <= 0) {
          $('#calcResult').text('Invalid amount').show();
          return;
        }
        let result = amt * (1 + lastReturnPct/100.0);
        $('#calcResult').text(`‚âà ${fmtPnL(result)}`).show();
      });
      $('#toggleErrorCol').change(function(){
        if(this.checked){
          $('.col-error').show();
        } else {
          $('.col-error').hide();
        }
      });
    });
  </script>

  <script>
    particlesJS("particles-js", {
      "particles": {
        "number": { "value": 60, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#4CAF50" },
        "shape": { "type": "circle" },
        "opacity": { "value": 0.4, "random": false, "anim": { "enable": false } },
        "size": { "value": 3, "random": true },
        "line_linked": { "enable": true, "distance": 150, "color": "#4CAF50", "opacity": 0.3, "width": 1 },
        "move": { "enable": true, "speed": 1.5, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": {
          "onhover": { "enable": true, "mode": "grab" },
          "onclick": { "enable": false },
          "resize": true
        },
        "modes": {
          "grab": { "distance": 140, "line_opacity": 0.5 },
          "bubble": { "distance": 400, "size": 40, "duration": 2, "opacity": 8, "speed": 3 },
          "repulse": { "distance": 200, "duration": 0.4 },
          "push": { "particles_nb": 4 },
          "remove": { "particles_nb": 2 }
        }
      },
      "retina_detect": true
    });
      // ===== Scroll Lock helpers =====
      const __scrollLock = { y: 0 };
      function lockBodyScroll() {
        __scrollLock.y = window.scrollY || document.documentElement.scrollTop || 0;
        document.body.classList.add('modal-open');
        document.body.style.position = 'fixed';
        document.body.style.top = `-${__scrollLock.y}px`;
        document.body.style.width = '100%';
      }
      function unlockBodyScroll() {
        document.body.classList.remove('modal-open');
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        window.scrollTo(0, __scrollLock.y);
      }

      // ===== Open / Close helpers =====
      function openModal(sel) {
        lockBodyScroll();
        $(sel).css('display','flex');
      }
      function closeModal(elOrSel) {
        const $m = (elOrSel instanceof HTMLElement) ? $(elOrSel) : $(elOrSel);
        $m.css('display','none');
        unlockBodyScroll();
      }

      // ===== Hook ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á =====
      // (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ .css('display','flex') / .css('display','none'))
      $('#tutorial-btn').off('click').on('click', function(){ openModal('#tutorial-modal'); });
      $('#glossary-btn').off('click').on('click', function(){ openModal('#glossary-modal'); });

      $('.close-btn').off('click').on('click', function(){ closeModal($(this).closest('.modal')[0]); });

      // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
      $('.modal').off('click').on('click', function(e){
        if (e.target === this) closeModal(this);
      });

      // ‡∏Å‡∏±‡∏ô‡∏™‡∏Å‡∏£‡∏≠‡∏•‡∏´‡∏•‡∏∏‡∏î‡πÑ‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (iOS ‡∏ö‡∏≤‡∏á‡∏Å‡∏£‡∏ì‡∏µ)
      $('.modal').on('wheel touchmove', function(e){
        if (e.target === this) e.preventDefault();
      });
  </script>
</body>
</html>
